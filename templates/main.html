{% extends "base.html" %}

{% block title %} Talent Marketplace Assignment Team Interface
{% block subject %}
{% endblock %}
{% endblock %}

{% block header %}

<style>
.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}
</style>

<script src="{{ url_for('bower.static', filename='d3/d3.min.js') }}"></script>

<script>
var airmen = [
	{%for amn in airmen%}
	{	name: '{{amn[0]}}',
		afsc: '{{amn[1]}}',
		aad : '{{amn[2]}}',
		type: 'airman'
	},
	{%endfor%}
]

var billets = [
	{%for bil in billets%}
	{	name: '{{bil[0]}}',
		afsc: '{{bil[1]}}',
		aad : '{{bil[2]}}',
		type: 'billet'
	},
	{%endfor%}
]

var nodes = airmen.concat(billets);


// Note: source and target MUST be used as the dictionary's keys!
var matches = [
	{%for match in matches%}
	{	source: '{{match[0]}}',
		target: '{{match[1]}}'
	},
	{%endfor%}
]


$(function(){

    var svg = d3.select("svg"),
		width = +svg.attr("width"),
		height = +svg.attr("height");

	var color = d3.scaleOrdinal(d3.schemeCategory10);

	var attractForce = d3.forceManyBody()
	                    .strength(200)
	                    .distanceMax(400)
	                    .distanceMin(60);
	var repelForce = d3.forceManyBody()
	                   .strength(-4000)
	                   .distanceMax(100)
	                   .distanceMin(0);


	simulation = d3.forceSimulation()
		.force("link", d3.forceLink().id(function(d) { return d.name; }))
		.force("charge", d3.forceManyBody())
		.force("attractForce", attractForce)
		.force("repelForce", repelForce);


  	var link = svg.append("g")
   	    .attr("class", "links")
  	    .selectAll("line")
   	    .data(matches)
        .enter().append("line")
        .attr("stroke-width", function(d) { return Math.sqrt(10); });

    var node = svg.append("g")
    	.attr("class", "nodes")
    	.selectAll("circle")
    	.data(nodes)
    	.enter().append("circle")
    	.attr("r", 10)
      	.attr("fill", function(d) { return color(d.type); })
      	.on("mouseover", function(d){
      		//Get this bar's x/y values, then augment for the tooltip
			var xPosition = parseFloat(d3.select(this).attr("cx") - 5);
			var yPosition = parseFloat(d3.select(this).attr("cy") - 5);

			svg.append("text")
			   .attr("id", "tooltip")
			   .attr("x", xPosition)
			   .attr("y", yPosition)
			   .attr("text-anchor", "middle")
			   .attr("font-family", "sans-serif")
			   .attr("font-size", "11px")
			   .attr("font-weight", "bold")
			   .attr("fill", "black")
			   .html(d.name);
      	})
      	.on("mouseout", function(){
      		d3.select("#tooltip").remove();
      	})
      	.call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));


	simulation
	    .nodes(nodes)
	    .on("tick", ticked);

	simulation.force("link")
	  .links(matches);

	function ticked() {
	     link
	         .attr("x1", function(d) { return d.source.x; })
	         .attr("y1", function(d) { return d.source.y; })
	         .attr("x2", function(d) { return d.target.x; })
	         .attr("y2", function(d) { return d.target.y; });

	    node
	    	.each(function(d){
	    		if (d.type == "airman"){
	    			d.x += (width/4 - d.x) * 0.5;
	    		} else {
	    			d.x += ((width - width/4) - d.x) * 0.5;
	    		}
	    		d.y += (height/2 - d.y) * 0.01;
	    	})
	        .attr("cx", function(d) { return d.x; })
	        .attr("cy", function(d) { return d.y; });
	  }

	// Functions for dragging.
	function dragstarted(d) {
	  if (!d3.event.active) simulation.alphaTarget(0.1).restart();
	  d.fx = d.x;
	  d.fy = d.y;
	}

	function dragged(d) {
	  d.fx = d3.event.x;
	  d.fy = d3.event.y;
	}

	function dragended(d) {
	  if (!d3.event.active) simulation.alphaTarget(0);
	  d.fx = null;
	  d.fy = null;
	}

});


</script>

{% endblock %}

{% block content %}

<div align="center" class = "usa-banner-header">
<h2> Talent Marketplace Assignment Team Interface </h2>
</div>


<div class="usa-width-one-fourth">

<table id="constraints" class = "display" cellspacing="0" width="80%">
<thead>
<th> Airman </th>
<th> Billet </th>
<th> Constraint  </th>
</thead>

</table>

</div>
<div class="usa-width-one-half">
<svg width="800" height ="800" id="canvas"></svg>
</div>

<div class="usa-width-one-fourth">
<table id="matchview" class = "display" cellspacing="0" width="80%">
<thead>
<th> Attribute </th>
<th> Airman </th>
<th> Billet  </th>
</thead>

</table>
</div>


{% endblock %}